<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MotorScope</title>
<style>
/* ====== Base ====== */
:root{
  --bg:#ffffff;
  --muted:#6b7280;
  --accent:#0f62fe;

  /* Plate colours */
  --plate-face:#ffd100;     /* UK rear plate yellow */
  --plate-rim:#0b0b0b;      /* outer black rim */
  --plate-trim:#b7bcc6;     /* grey trim */
  --plate-blue:#1b3fbf;     /* EU blue band */
  --plate-text:#0b0b0b;     /* characters */
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
  color:#0f172a;
  background:var(--bg);
}

/* ====== Layout ====== */
.wrap{max-width:980px;margin:0 auto;padding:20px}

/* HERO centered on page */
.hero{
  min-height:60vh;
  display:grid;
  place-content:center;
  row-gap:16px;
  margin-top:0;
}

/* ====== Plate ====== */
.plate{
  width:min(900px, 95vw);
  aspect-ratio: 520 / 110;      /* realistic ratio */
  position:relative;
  display:flex; align-items:center; justify-content:center;
  margin:0 auto;

  border-radius:16px;
  background:var(--plate-rim);
  padding:7px;                           /* black rim thickness */
  box-shadow:
    0 10px 28px rgba(0,0,0,.18),
    inset 0 0 0 1px rgba(255,255,255,.08);
}
.plate-inner{
  position:relative; inset:0; width:100%; height:100%;
  background:linear-gradient(180deg, #ffda3a 0%, var(--plate-face) 100%);
  border-radius:12px;
  box-shadow:inset 0 0 0 4px var(--plate-trim);
  overflow:hidden;                  /* hard clip: nothing leaves yellow */
  display:flex; align-items:center;
}

/* Left EU blue band (fixed geometry) */
.plate-band{
  position:absolute; left:0; top:0; bottom:0;
  width:92px;
  min-width:92px; max-width:92px;
  background:var(--plate-blue);
  border-right:3px solid rgba(0,0,0,.28);
  display:flex; align-items:center; justify-content:center;
}
.band-svg{ width:70%; height:70%; }

/* Registration characters (visible layer) */
.plate-text-wrap{
  position:absolute; right:10px; left:110px;   /* starts after blue band */
  display:flex; align-items:center; justify-content:flex-start;
  height:100%;
  padding:0 12px;                 /* JS adds left padding to center text */
}
.plate-text{
  width:100%;
  text-align:left;                /* caret alignment technique */
  color:var(--plate-text);
  font-weight:900;
  letter-spacing:8px;
  font-family:"Arial Black","Impact",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  text-transform:uppercase;
  font-size:68px;                 /* JS fits down if needed */
  line-height:1;
  white-space:nowrap;
  overflow:hidden;                /* never overhang */
  text-shadow:0 1px 0 rgba(255,255,255,.35);
}

/* Real input (transparent) */
.plate-input{
  position:absolute; inset:0; width:100%;
  /* height set in JS to match wrap height */
  border:0; outline:0;
  background:transparent; color:transparent; caret-color:#111;
  text-align:left;                       /* caret at the true end */
  text-transform:uppercase; letter-spacing:8px;
  font-weight:900; font-size:68px; /* font-size matched with plate-text */
  /* line-height set in JS to vertically centre caret */
  font-family:"Arial Black","Impact",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
/* hide placeholder so it never overlaps visually */
.plate-input::placeholder{ color: transparent; }

/* Buttons */
.controls{display:flex; gap:12px; justify-content:center}
.btn{padding:11px 18px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a;cursor:pointer;font-weight:700}
.btn-primary{background:#2b58ff;color:#fff;border:0}
.btn-outline{background:#fff;border:1.5px solid #d1d5db}
#shareBtn{display:none}

/* ====== Results (unchanged UI below) ====== */
.section{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:16px;
  margin:0 0 14px 0;
  box-shadow:0 10px 20px rgba(0,0,0,.06);
}
.section h3{margin:0 0 10px;font-size:15px;color:#0f172a}
.row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eef2f7}
.row:last-child{border-bottom:0}
.meta{font-size:13px;color:#475569}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;color:#fff;font-weight:800;font-size:12px}
.chip-danger{background:#ff4d4f}
.chip-major{background:#ff7a00}
.chip-minor{background:#ffd12a;color:#222}
.chip-advisory{background:#8b8b8b}
.spark{width:100%;height:36px;background:linear-gradient(90deg,rgba(43,88,255,0.08),transparent);border-radius:8px;padding:6px}

#error{display:none}
#error .panel{background:#fff;border:1px solid #f9d2d2}

/* Small screens */
@media (max-width: 560px){
  .plate-text{letter-spacing:6px}
  .plate-input{letter-spacing:6px}
  .plate-band{width:80px; min-width:80px; max-width:80px}
  .plate-text-wrap{left:98px}
}
</style>
</head>
<body>

<!-- HERO: plate centered, no header -->
<div class="hero">
  <div class="plate" aria-label="Registration plate input">
    <div class="plate-inner">
      <!-- EU blue band with star circle + GB (SVG with no centre star) -->
      <div class="plate-band" aria-hidden="true">
        <svg viewBox="0 0 100 160" class="band-svg" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <g id="eustar">
              <polygon points="0,-5 1.5,-1.5 5,0 1.5,1.5 0,5 -1.5,1.5 -5,0 -1.5,-1.5" />
            </g>
          </defs>
          <g fill="#ffd100" transform="translate(50,58)">
            <!-- 12 stars on a circle radius 24, NO centre star -->
            <use href="#eustar" transform="rotate(0)   translate(0,-24)"/>
            <use href="#eustar" transform="rotate(30)  translate(0,-24)"/>
            <use href="#eustar" transform="rotate(60)  translate(0,-24)"/>
            <use href="#eustar" transform="rotate(90)  translate(0,-24)"/>
            <use href="#eustar" transform="rotate(120) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(150) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(180) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(210) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(240) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(270) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(300) translate(0,-24)"/>
            <use href="#eustar" transform="rotate(330) translate(0,-24)"/>
          </g>
          <text x="50" y="128" fill="#ffffff" font-size="34" font-weight="900" font-family="Arial Black, Impact, sans-serif" text-anchor="middle">GB</text>
        </svg>
      </div>

      <!-- Visible reg text -->
      <div class="plate-text-wrap">
        <div id="plateText" class="plate-text">&nbsp;</div>
      </div>

      <!-- Real input -->
      <input id="plateInput" class="plate-input" maxlength="9"
             autocomplete="off" spellcheck="false" inputmode="text"
             placeholder="TYPE REGISTRATION" />
    </div>
  </div>

  <div class="controls">
    <button id="searchBtn" class="btn btn-primary">Search</button>
    <button id="clearBtn" class="btn btn-outline">Clear</button>
    <button id="shareBtn" class="btn">Share</button>
  </div>
</div>

<!-- ERROR -->
<div id="error" class="wrap">
  <div class="section"><div id="errorText" class="meta"></div></div>
</div>

<!-- RESULTS -->
<div class="wrap">
  <div id="vehiclePanel" class="section" style="display:none">
    <h3>Vehicle summary</h3>
    <div class="row"><div>Registration</div><div id="v_reg" class="meta"></div></div>
    <div class="row"><div>Make / Model</div><div id="v_make" class="meta"></div></div>
    <div class="row"><div>Colour</div><div id="v_colour" class="meta"></div></div>
    <div class="row"><div>Fuel</div><div id="v_fuel" class="meta"></div></div>
    <div class="row"><div>MOT status</div><div id="v_mot" class="meta"></div></div>
    <div style="margin-top:10px">
      <h3>Mileage (sparkline)</h3>
      <div id="miles" class="spark"></div>
    </div>
  </div>

  <div id="motPanel" class="section" style="display:none">
    <h3>MOT history</h3>
    <div id="motList" style="font-size:13px"></div>
    <div style="margin-top:8px"><strong>Defects</strong></div>
    <div id="defects" style="margin-top:6px" class="chips"></div>
    <div style="margin-top:10px" class="meta">
      <label><input type="checkbox" id="failsOnly"> Show fails only</label>
    </div>
  </div>

  <div id="extraPanel" class="section" style="display:none">
    <h3>Additional reports</h3>
    <div id="police" class="meta" style="margin-bottom:8px"></div>
    <div id="insurance" class="meta"></div>
  </div>

  <div id="ownerPanel" class="section" style="display:none">
    <h3>Owner / Title</h3>
    <div id="ownerInfo" class="meta">Only when available via upstream APIs.</div>
  </div>

  <div id="rawPanel" class="section" style="display:none">
    <h3>Raw data (download)</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="downloadJson" class="btn">Download JSON</button>
      <button id="downloadCsv" class="btn">Download CSV</button>
    </div>
  </div>
</div>

<script>
/* ===== Config ===== */
const BACKEND = 'https://motorscope-backend.riystt.workers.dev'; // your Worker URL
const antispamTimeout = 8000;

/* ===== DOM ===== */
const $ = s => document.querySelector(s);
const plateInput = $('#plateInput');
const plateText  = $('#plateText');
const searchBtn  = $('#searchBtn');
const clearBtn   = $('#clearBtn');
const shareBtn   = $('#shareBtn');
const errorBox   = $('#error');
const errorText  = $('#errorText');
const failsOnly  = $('#failsOnly');

/* ===== Helpers ===== */
function formatUK(s){
  s = String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,7);
  if(s.length>4) return s.slice(0,4) + ' ' + s.slice(4);   // include visual space
  return s;
}
function compactVRM(s){ return String(s||'').replace(/\s+/g,''); }
function showError(msg){ errorText.textContent = msg; errorBox.style.display='block'; }
function hideError(){ errorBox.style.display='none'; errorText.textContent=''; }
function show(id){ const el=document.getElementById(id); if(el) el.style.display='block'; }
function hide(id){ const el=document.getElementById(id); if(el) el.style.display='none'; }
function hideAll(){ ['vehiclePanel','motPanel','extraPanel','ownerPanel','rawPanel'].forEach(hide); shareBtn.style.display='none'; }

/* ===== Plate typing + auto-fit + visual centering with left padding ===== */
function setPlateDisplay(v){
  plateText.textContent = v || ' ';
  fitText();
}

function fitText(){
  const wrap = document.querySelector('.plate-text-wrap');
  if(!wrap) return;
  const maxW = wrap.clientWidth - 8;     // some safety
  // start big, shrink until it fits
  let size = Math.min(68, wrap.clientHeight * 0.72);
  plateText.style.fontSize = size + 'px';
  plateInput.style.fontSize = size + 'px';
  while (plateText.scrollWidth > maxW && size > 26){
    size -= 1;
    plateText.style.fontSize = size + 'px';
    plateInput.style.fontSize = size + 'px';
  }
  centerByPadding();
}

// Center the whole visible string by adding left padding to the wrap,
// and apply equivalent padding to the input so the caret sits at the true end.
// Also set input height/line-height to vertically center the caret.
function centerByPadding(){
  const wrap = document.querySelector('.plate-text-wrap');
  const hasText = plateText.textContent.trim().length > 0 && plateText.textContent.trim() !== 'TYPE REGISTRATION';
  const textWidth = hasText ? plateText.scrollWidth : 0;  // focus-empty => caret in true center
  const pad = Math.max(0, (wrap.clientWidth - textWidth) / 2);
  wrap.style.paddingLeft = pad + 'px';
  plateInput.style.paddingLeft = (pad + 12) + 'px'; // +12 base padding
  // vertical caret centering
  plateInput.style.height = wrap.clientHeight + 'px';
  plateInput.style.lineHeight = wrap.clientHeight + 'px';
}

/* Input behavior */
plateInput.addEventListener('focus', ()=>{
  if(!plateInput.value){
    // Remove large placeholder text visually and centre caret
    setPlateDisplay('');
    centerByPadding();
  }
  // Move caret to end of value
  requestAnimationFrame(()=>{
    const end = plateInput.value.length;
    plateInput.setSelectionRange(end,end);
  });
});

plateInput.addEventListener('blur', ()=>{
  if(!plateInput.value){
    setPlateDisplay('TYPE REGISTRATION');
    fitText();
  }
});

plateInput.addEventListener('input', e=>{
  const formatted = formatUK(e.target.value);
  // Keep the *same* string (with space) in the input so the caret aligns with the visible text.
  e.target.value = formatted;
  setPlateDisplay(formatted);
});

window.addEventListener('resize', fitText);

clearBtn.addEventListener('click', ()=>{
  plateInput.value='';
  setPlateDisplay('TYPE REGISTRATION');
  fitText();
  hideAll(); history.replaceState({},'',location.pathname);
});

/* ===== Networking ===== */
async function getAntiToken(vrm){
  const ctl = new AbortController(); const t=setTimeout(()=>ctl.abort(), antispamTimeout);
  const r = await fetch(BACKEND+'/api/antispam',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({vrm}),signal:ctl.signal});
  clearTimeout(t);
  if(!r.ok){ throw new Error(await r.text() || ('antispam failed '+r.status)); }
  const j = await r.json(); return j && j.token || null;
}
async function callVES(vrm, token){
  const u = new URL(BACKEND+'/api/ves'); u.searchParams.set('vrm', vrm);
  const h = token? {'x-client-token':token} : {};
  const r = await fetch(u,{headers:h});
  if(!r.ok) throw new Error(await r.text() || ('VES error '+r.status));
  return r.json();
}
async function callMOT(vrm, token){
  const u = new URL(BACKEND+'/api/mot/tests'); u.searchParams.set('vrm', vrm);
  const h = token? {'x-client-token':token} : {};
  const r = await fetch(u,{headers:h});
  if(!r.ok){ const t = await r.text(); try{return JSON.parse(t)}catch{throw new Error(t||('MOT error '+r.status));} }
  return r.json();
}
/* Optional extras – may respond 501 until implemented in Worker */
async function callExtra(endpoint, vrm, token){
  const u = new URL(BACKEND+endpoint); u.searchParams.set('vrm', vrm);
  const h = token? {'x-client-token':token} : {};
  const r = await fetch(u,{headers:h});
  if(!r.ok){ const t = await r.text(); try{return JSON.parse(t)}catch{return {error:t}} }
  try{ return await r.json(); }catch{ return {error:'No JSON'} }
}

/* ===== Rendering ===== */
function renderVehicle(d){
  $('#v_reg').textContent   = d.registrationNumber || '';
  $('#v_make').textContent  = (d.make||'') + (d.model? ' / '+d.model:'');
  $('#v_colour').textContent= d.colour || '';
  $('#v_fuel').textContent  = d.fuelType || '';
  $('#v_mot').textContent   = d.motStatus || '';
  show('vehiclePanel');
}
function drawSparkline(id, values){
  const el = document.getElementById(id); el.innerHTML='';
  if(!values || values.length<2){ el.textContent = values && values.length? values.join(', '): '—'; return; }
  const w = el.clientWidth, h = el.clientHeight;
  const max = Math.max(...values), min = Math.min(...values);
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',w); svg.setAttribute('height',h);
  const pts=values.map((v,i)=>{ const x=(i)/(values.length-1)*(w-8)+4; const y=h-4-((v-min)/(max-min)*(h-8)); return [x,y]; });
  const p=document.createElementNS(svgNS,'path'); p.setAttribute('d',pts.map((p,i)=>(i?'L':'M')+p[0].toFixed(2)+' '+p[1].toFixed(2)).join(' '));
  p.setAttribute('stroke','#2b58ff'); p.setAttribute('fill','none'); p.setAttribute('stroke-width','2'); svg.appendChild(p); el.appendChild(svg);
}
function renderMOT(list){
  const container = $('#motList'); container.innerHTML='';
  const defects   = $('#defects'); defects.innerHTML='';
  const tests = Array.isArray(list)? list : (list && list.tests) || [];
  const filtered = failsOnly && failsOnly.checked ? tests.filter(t=>/(fail|refuse)/i.test(t.result||t.testResult||'')) : tests;
  if(!filtered.length){ container.textContent='No MOT history found.'; show('motPanel'); return; }
  filtered.slice(0,12).forEach(t=>{
    const el = document.createElement('div'); el.style.padding='8px 0';
    el.innerHTML = `<div style="font-weight:800">${t.date||t.testDate||''} — ${t.odometer ? (t.odometer+' '+(t.odometerUnit||'')) : ''}</div>
                    <div class="meta">${t.testResult||t.result||''}${t.testStationName? ' — '+t.testStationName:''}</div>`;
    container.appendChild(el);
    if(t.defects && Array.isArray(t.defects)){
      t.defects.forEach(df=>{
        const span = document.createElement('span');
        const level = (df.type||df.level||'').toLowerCase();
        span.className = 'chip ' + (level.includes('danger')?'chip-danger':level.includes('major')?'chip-major':level.includes('minor')?'chip-minor':'chip-advisory');
        span.textContent = (df.type||'DEF').toUpperCase() + ': ' + (df.summary||df.description||df.name||'');
        defects.appendChild(span);
      });
    }
  });
  show('motPanel');
  const mileage = tests.map(x=> Number(x.odometer||0) || null).filter(Boolean).slice(-12);
  drawSparkline('miles', mileage);
}
function renderExtras(pol, ins){
  const p = $('#police'); p.textContent = pol && !pol.error ? (pol.summary || JSON.stringify(pol)) : 'No police data available';
  const i = $('#insurance'); i.textContent = ins && !ins.error ? (ins.summary || JSON.stringify(ins)) : 'No insurance/enquiry data available';
  show('extraPanel');
}

/* Downloads */
document.getElementById('downloadJson').addEventListener('click', ()=>{
  if(!window._lastData) return alert('No data to download');
  const blob = new Blob([JSON.stringify(window._lastData,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(window._lastData.registrationNumber||'motorscope')+'.json'; a.click();
});
document.getElementById('downloadCsv').addEventListener('click', ()=>{
  if(!window._lastData) return alert('No data to download');
  const obj=window._lastData.ves||{}; const keys=Object.keys(obj);
  const csv=[keys.join(','), keys.map(k=>String(obj[k]??'')).join(',')].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=(window._lastData.registrationNumber||'motorscope')+'.csv'; a.click();
});

/* Main search */
searchBtn.addEventListener('click', async ()=>{
  hideAll(); hideError();
  const vrm = compactVRM(plateText.textContent || plateInput.value || '');
  if(!vrm){ showError('Please enter a registration plate'); return; }
  searchBtn.disabled=true; searchBtn.textContent='Searching…';
  try{
    const token = await getAntiToken(vrm);
    const ves   = await callVES(vrm, token);
    renderVehicle(ves);
    const mot   = await callMOT(vrm, token);
    renderMOT(mot);
    const pol   = await callExtra('/api/police', vrm, token);
    const ins   = await callExtra('/api/insurance', vrm, token);
    renderExtras(pol,ins);

    document.getElementById('ownerInfo').textContent = (ves.owner || ves.title || '') || 'Not available via VES';
    show('ownerPanel'); show('rawPanel');

    window._lastData = { registrationNumber: ves.registrationNumber || vrm, ves, mot, police:pol, insurance:ins };
    shareBtn.style.display='inline-block';

    history.replaceState({},'', '?vrm=' + encodeURIComponent(vrm.toLowerCase()));
  }catch(e){
    console.error(e); showError('Lookup failed: ' + (e.message || 'Unknown error'));
  }finally{
    searchBtn.disabled=false; searchBtn.textContent='Search';
  }
});

/* Share */
shareBtn.addEventListener('click', ()=>{
  if(!window._lastData) return;
  const url = location.origin + location.pathname + '?share=' + encodeURIComponent(btoa(JSON.stringify(window._lastData)));
  navigator.clipboard.writeText(url).then(()=> alert('Share URL copied to clipboard'));
});

/* Init */
(function init(){
  const params=new URLSearchParams(location.search);
  const q=params.get('vrm')||params.get('q');
  if(q){ plateInput.value=formatUK(q); setPlateDisplay(formatUK(q)); }
  if(!plateText.textContent.trim()){ setPlateDisplay('TYPE REGISTRATION'); }
  fitText();
})();
</script>
</body>
</html>
