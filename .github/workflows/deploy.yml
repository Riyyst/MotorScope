name: Deploy MotorScope Backend (Cloudflare Worker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            wrangler --version

            # Push secrets
            wrangler secret put ANTISPAM_SECRET --text "${{ secrets.ANTISPAM_SECRET }}"
            wrangler secret put DVLA_VES_API_KEY --text "${{ secrets.DVLA_VES_API_KEY }}"

            # DVSA
            if [ -n "${{ secrets.DVSA_MOT_CLIENT_ID }}" ]; then wrangler secret put DVSA_MOT_CLIENT_ID --text "${{ secrets.DVSA_MOT_CLIENT_ID }}"; fi
            if [ -n "${{ secrets.DVSA_MOT_CLIENT_SECRET }}" ]; then wrangler secret put DVSA_MOT_CLIENT_SECRET --text "${{ secrets.DVSA_MOT_CLIENT_SECRET }}"; fi
            if [ -n "${{ secrets.DVSA_MOT_TOKEN_URL }}" ]; then wrangler secret put DVSA_MOT_TOKEN_URL --text "${{ secrets.DVSA_MOT_TOKEN_URL }}"; fi
            if [ -n "${{ secrets.DVSA_MOT_SCOPE }}" ]; then wrangler secret put DVSA_MOT_SCOPE --text "${{ secrets.DVSA_MOT_SCOPE }}"; fi
            if [ -n "${{ secrets.DVSA_MOT_API_KEY }}" ]; then wrangler secret put DVSA_MOT_API_KEY --text "${{ secrets.DVSA_MOT_API_KEY }}"; fi

            # FRONTEND_ORIGIN
            if [ -n "${{ secrets.FRONTEND_ORIGIN }}" ]; then wrangler secret put FRONTEND_ORIGIN --text "${{ secrets.FRONTEND_ORIGIN }}"; fi

            # Deploy
            wrangler deploy --name motorscope-backend --verbose
