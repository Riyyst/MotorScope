name: Deploy MotorScope Backend (Cloudflare Worker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm i -g wrangler@3

      # We’ll call wrangler directly with env vars. No config file required.
      - name: Verify Cloudflare auth
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: wrangler whoami

      - name: Push secrets to Cloudflare (GitHub = single source of truth)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID:        ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          # === Your app secrets in GitHub ===
          FRONTEND_ORIGIN:      ${{ secrets.FRONTEND_ORIGIN }}
          ANTISPAM_SECRET:      ${{ secrets.ANTISPAM_SECRET }}

          DVLA_VES_API_KEY:     ${{ secrets.DVLA_VES_API_KEY }}

          DVSA_MOT_CLIENT_ID:     ${{ secrets.DVSA_MOT_CLIENT_ID }}
          DVSA_MOT_CLIENT_SECRET: ${{ secrets.DVSA_MOT_CLIENT_SECRET }}
          DVSA_MOT_TOKEN_URL:     ${{ secrets.DVSA_MOT_TOKEN_URL }}
          DVSA_MOT_SCOPE:         ${{ secrets.DVSA_MOT_SCOPE }}
          DVSA_MOT_API_KEY:       ${{ secrets.DVSA_MOT_API_KEY }}
        run: |
          set -euo pipefail
          NAME="motorscope-backend"

          cf_secret () {
            local KEY="$1" ; local VAL="$2"
            # always delete then re-put so we never fail with “already in use” (10053)
            wrangler secret delete "$KEY" --name "$NAME" --account-id "$CF_ACCOUNT_ID" --quiet || true
            printf "%s" "$VAL" | wrangler secret put "$KEY" --name "$NAME" --account-id "$CF_ACCOUNT_ID" --quiet
          }

          # Push each secret from GitHub → Cloudflare
          cf_secret FRONTEND_ORIGIN   "${FRONTEND_ORIGIN}"
          cf_secret ANTISPAM_SECRET   "${ANTISPAM_SECRET}"

          cf_secret DVLA_VES_API_KEY  "${DVLA_VES_API_KEY}"

          cf_secret DVSA_MOT_CLIENT_ID     "${DVSA_MOT_CLIENT_ID}"
          cf_secret DVSA_MOT_CLIENT_SECRET "${DVSA_MOT_CLIENT_SECRET}"
          cf_secret DVSA_MOT_TOKEN_URL     "${DVSA_MOT_TOKEN_URL}"
          cf_secret DVSA_MOT_SCOPE         "${DVSA_MOT_SCOPE}"
          cf_secret DVSA_MOT_API_KEY       "${DVSA_MOT_API_KEY}"

      - name: Deploy worker code
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID:        ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # publish worker.mjs as "motorscope-backend" without a wrangler.toml
          wrangler deploy worker.mjs \
            --name motorscope-backend \
            --account-id "$CF_ACCOUNT_ID" \
            --compatibility-date 2024-11-01
